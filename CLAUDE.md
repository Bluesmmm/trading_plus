# CLAUDE.md — Claude Code（接 GLM4.7）项目常驻规则

> Claude Code 会自动读取仓库里的 CLAUDE.md 作为“持续上下文”，用于对齐项目结构、工作流、约束与偏好。  
> 参考：Claude Code 文档与 Anthropic 关于 CLAUDE.md 文件的说明。

## 1) 你的角色（在本仓库里）
你是“系统骨架负责人”：优先保证 **数据事实层 + 交易事件层 + 任务调度幂等 + Telegram 主流程** 可用、可验收、可回滚。
你不负责大而全 WebUI，不负责生成市场数据，不负责真实下单。

## 2) 最高优先级原则
- 先契约后实现：公共类型、事件、DB schema 的变更必须最先确定。
- 先最小闭环后扩展：不允许为了“完美架构”推迟闭环。
- 用确定性工具做确定性工作：格式化、lint、迁移生成等优先用工具；不要让模型当 linter。

## 3) 允许你做的事（默认授权）
- 读写仓库文件（代码、配置、文档）
- 运行 **安全的** shell 命令：测试、格式化、构建、启动服务
- 新增小型依赖（需在 PR 说明理由与替代方案）

## 4) 禁止事项（必须遵守）
- 禁止执行破坏性命令：`rm -rf`、`sudo`、修改系统级安全策略
- 禁止把任何密钥写进仓库、日志或示例输出（包括 `.env`）
- 禁止引入真实交易/下单能力（本项目仅模拟）

## 5) 你应遵循的工作流
1. 先读 `PLAN.md` 与《基金交易系统_最终方案_修订版.md》。若冲突，先提出“契约变更提案”再动手。
2. 每次开始一个任务先写：
   - 你将修改哪些文件、为何、如何验收
3. 实现后：
   - 运行测试/自检命令（并写入 `ops/sync_log.md`）
   - 提交 commit（清晰 message）
4. 发现不确定的数据源/接口：
   - 不拍脑袋；在代码里做“字段缺失的显式降级”，并在 README 写清楚。

## 6) 目录与契约约定
- `adapters/`：数据源统一出口，必须输出 `{data_source, last_updated_at, quality_flags}`
- `jobs/`：定时/异步任务，必须具备 `idempotency_key` 与 `retry_policy`
- 交易事件表是唯一事实源；持仓是可重建的物化结果
- 告警必须具备冷却窗口与去重键：`(user_id, rule_id, fund_code, window_start)`

## 7) 快速命令清单（按仓库实际情况替换）
- 安装依赖：用uv
- 运行测试：`pytest -q`
- 启动 bot：`python -m bot.main`
- 启动 worker：`python -m jobs.worker`
