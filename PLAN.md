# PLAN.md — 基金交易系统行动计划

## 0. 交付范围（本轮必须做）
1. **数据闭环（事实层）**：基金/ETF 价格与净值数据拉取 -> 入库 -> 查询接口返回 `{data_source, last_updated_at}`。
2. **模拟交易闭环（事件层）**：`buy_sim/sell_sim` -> 交易事件落库（幂等）-> T+1 结算任务 -> 持仓与盈亏可重建。
3. **预警闭环（规则层）**：规则创建/更新 -> 定时计算 -> 去重+冷却窗口 -> Telegram 推送。
4. **AI 分析（解释层）**：仅消费结构化事实 JSON；输出强制 JSON schema；结果可追溯落库（含输入 hash、prompt 版本、模型信息）。

## 1. 非目标（本轮不做/明确延期）
- 真实下单、接券商/基金公司真实交易接口
- 大而全 WebUI（仅保留只读运维面板：健康/任务/告警摘要）
- 复杂持仓穿透与公告/季报全量抓取（只做“可用则展示，不可用则解释缺失原因”）

## 2. 验收标准（DoD）
- DoD-1：对 10 只基金/ETF，接口返回数据带 `data_source` 与 `last_updated_at`，并可复现。
- DoD-2：所有写入动作具备 `idempotency_key`；重复调用不会产生重复交易/重复告警。
- DoD-3：结算状态机可回放：以交易流水为事实源，能重建持仓。
- DoD-4：预警具有冷却窗口，连续波动不会刷屏；可在 DB 中追踪“上次发送时间/原因”。
- DoD-5：AI 输出严格符合 JSON schema；不得编造数字；引用字段必须来自输入 JSON。
- DoD-6：Secrets 不入库、不入日志、不进仓库；配置走环境变量或安全配置文件（不提交）。
- DoD-7：一键启动与健康检查可用（README 说明 + `make run` / `docker compose up` 二选一）。

## 3. 并行分工（两个窗口的“代码所有权”）
### 窗口 A：Claude Code（系统骨架负责人）
负责：数据源 Adapter、DB schema/迁移、任务调度与幂等、Telegram Bot 主流程、告警规则引擎。
- 仅该窗口可以改：`/db/schema*`、`/core/events*`、`/core/types*`（契约文件）
- 输出：可运行的“骨架闭环”与最小集命令 `/nav /buy_sim /sell_sim /settle /alert_add /alert_list`

### 窗口 B：Kimi Code（AI + 运维负责人）
负责：AI JSON schema、裁决器、缓存与可追溯、只读运维面板、监控/日志规范、回测与组合优化（简化版）。
- 仅该窗口可以改：`/ai/*`、`/ops/*`、`/web_admin/*`、`/backtest/*`
- 输出：`/analyze` 与 `/portfolio_opt` 先跑通单模型结构化输出，再接三模型裁决。

> 禁止两个窗口同时改同一文件。若必须跨界改动，先在 `ops/sync_log.md` 写“变更提案”，由契约负责人合并。

## 4. 分支与合并规则（防冲突）
- 主分支：`main`；开发分支：`dev/claude`、`dev/kimi`
- **契约文件变更**必须走 PR（或本地 `git diff` 评审）并在 PLAN 里记录版本号：`CONTRACT_VERSION=YYYYMMDD.N`
- 合并前必须跑：`pytest -q`（或你项目实际测试命令）+ `python -m compileall .`

## 5. 同步节奏（不中断但要收敛）
- 每 45–60 分钟一次同步点：在 `ops/sync_log.md` 追加四行：
  - 完成了什么（含文件列表）
  - 当前阻塞
  - 下一步
  - 需要对方配合的契约/接口

## 6. 数据源策略（基金系统优先级）
> 目标：基金净值/基础信息为核心，行情为辅助。WSJ 仅作资讯解释层。
- **主源（场外基金净值/基础信息）**：东方财富/天天基金（可通过 AkShare 快速接入；或直连端点）。
- **场内 ETF 行情（可选）**：东方财富/券商行情源（如需分钟级则另加）。
- **付费替代（更稳）**：东方财富 Choice（EmQuant API）替代网页抓取的不稳定性。
- **资讯解释**：Wall Street Journal（Dow Jones 开发者平台/Top Stories）仅用于“事件解释与风险提示”，不作为净值/行情事实源。

## 7. 安全护栏（两端工具通用）
- 任何自动化命令不得执行：`rm -rf`、`sudo`、修改系统网络/防火墙、上传密钥到第三方。
- 重大重构前先 `git commit`，并在 PR 描述写回滚策略。
- 所有外部数据写入前必须做字段校验：日期、数值范围、缺失值解释。

## 8. 最小里程碑建议（按你 5 日冲刺）
- Day 1：骨架闭环（数据->入库->查询；交易->结算->持仓；告警去重）
- Day 2：数据源冗余与降级；任务状态机与重试；Bot 命令稳定
- Day 3：回测简化版 + 组合优化简化版（只消费事实数据）
- Day 4：AI 单模型结构化输出 -> 三模型裁决；全链路追溯入库
- Day 5：部署、监控、回滚演练；README/Runbook 完整

## 9. 你要做的“总调度”动作（每天固定）
- 早：确认当日 DoD 与冻结契约版本
- 中：处理跨窗口冲突与阻塞
- 晚：跑一遍端到端回归脚本 + 打 tag：`v0.x.y`
