# 基金交易系统（Telegram 核心）——5日冲刺最终方案（修订版）
**版本**：v1.0 (Revised)  
**日期**：2026-01-28  
**定位**：仅基金/ETF的**模拟交易**与**预警/分析**系统（不接真实申购赎回/真实下单）  

---

## 1. 目标、范围与非目标

### 1.1 业务目标
在 5 天内交付一个“可上线、可运维、可复现”的基金/ETF 模拟交易与预警系统：
- 以 **Telegram Bot** 作为主要交互入口：查询、持仓、定投、预警、报告。
- 支持 **模拟交易**（买入/卖出/定投），支持 T+1 结算语义（可配置）。
- 支持 **基于规则的预警**（净值/涨跌幅/回撤/波动等）与可解释输出。
- 支持 **AI 辅助分析**（三模型裁决器 + 结构化输出），但严格限制为“基于事实数据的总结与风险提示”。

### 1.2 交付范围（MVP）
- 覆盖品类：  
  - 场外公募基金：以“每日净值”为核心  
  - 场内 ETF：日线/快照数据（用于风控、指数代理、情景分析）
- 核心能力：  
  - 数据采集入库（含健康检查与降级）  
  - 模拟交易与持仓（事件流 + 可重建）  
  - 预警系统（去重 + 冷却窗口 + 推送）  
  - 分析与回测（最小可用）  
  - 监控与审计日志（最小可用）  
  - 一键部署（Docker）

### 1.3 非目标（明确不做）
- 不做真实下单、真实申购赎回；不保存任何券商/交易账户凭据。
- 不承诺“实时净值”（场外基金通常为 T+1 公布净值；系统以数据源更新时间为准）。
- 不做完整投顾能力；AI 输出不提供强指令型“必须买/必须卖”。

---

## 2. 成功标准（可验收）

### 2.1 硬指标（上线验收必须满足）
1) **数据正确性可复现**  
- 对 10 只基金/ETF：同一数据源下，入库数据与源站一致（允许可配置误差阈值与四舍五入规则）。  
- 系统返回必须携带 `data_source` 与 `last_updated_at`。

2) **任务一致性与幂等**  
- 数据同步、结算、预警推送均具有 `idempotency_key`。  
- 同一任务重复执行不得造成重复交易记录与重复告警。

3) **安全边界清晰**  
- 代码层面不存在真实下单依赖；所有“交易”都落在模拟表。  
- 密钥不落库、不入日志；用户数据按 Telegram `user_id` 级隔离。

### 2.2 软指标（上线后一周内优化到位）
- 机器人交互：95% 请求在 3 秒内返回（AI 分析可异步推送结果）。  
- 数据同步：每日净值更新在数据源可得后的 30 分钟内完成。  
- 预警到达：触发到推送 < 60 秒（可按任务频率调整）。

---

## 3. 总体架构

### 3.1 组件划分
- **Telegram Bot（入口层）**：只做命令解析、鉴权、投递任务、推送结果（避免重逻辑阻塞）。
- **API Service（应用层）**：REST/内部RPC，负责读写聚合、权限校验、返回结构化结果。
- **Worker（作业层）**：数据同步、回测、结算、预警、AI 分析，支持重试/补偿。
- **Scheduler（调度层）**：统一定时任务（单实例执行或分布式锁），避免多副本重复跑。
- **PostgreSQL（事实库）**：交易事件、净值时间序列、告警与审计。
- **Redis（可选）**：分布式锁、短期缓存、去重键、任务队列（如采用RQ/Celery）。
- **LLM Providers（外部）**：GLM / DeepSeek / MiniMax；由统一 Provider 适配层调用。

### 3.2 数据流（简化）
1) 用户命令 → Bot → API（写入“命令事件”）→ Worker 执行 → 写入事实库 → Bot 推送结果  
2) Scheduler → Worker：净值同步/结算/预警 → 写入告警 → Bot 推送  
3) 分析请求 → Worker 生成“结构化事实 JSON” → 三模型输出 → 裁决器生成最终 JSON → 入库 → Bot 推送  

---

## 4. 数据源策略（含“东方财富/WSJ 是否可替代”结论）

### 4.1 结论概览
- **东方财富（天天基金网）**可以作为公募基金“每日净值/估值/排行等”核心数据来源；它更像是 AkShare 的“上游数据提供者”。你可以：
  - 继续使用 AkShare 作为抓取封装（开发最快）；或  
  - 直接对接东方财富网页接口/解析页面（依赖更少但维护更高）；或  
  - 采购 **Choice 数据量化接口（EmQuantAPI）**作为更稳定的商业数据源。  

- **WSJ**属于“新闻内容/资讯”数据源，适合作为宏观/事件解释与风控提示输入，但**不是净值/行情数据的平替**：  
  - 它能通过 Dow Jones/WSJ 的内容 API 提供新闻内容流（需企业/订阅授权），用于“新闻驱动风险提示/事件解释”。  
  - 但无法替代基金净值、持仓、费率等交易事实数据。  

### 4.2 数据字段与最低需求
系统最小可用需要：
- 场外基金：基金代码、名称、单位净值、累计净值、日涨跌、申购/赎回状态、更新时间  
- 场内ETF：代码、OHLCV（日线）、涨跌、成交额、（可选）分钟快照  
- 基础元数据：基金类型、费率、基金公司（可选）

### 4.3 数据源分层（推荐）
**免费/快速层（MVP首选）**
- 东方财富-天天基金网（场外基金净值、估值、排行等）  
  - 特性：交易日 16:00–23:00 更新当日最新开放式基金净值（以源站为准）  
- 交易所/行情快照（用于ETF/指数代理）  
  - 可使用富途快照作为补充（若你的部署形态允许）

**可选增强层（如果你有权限/预算）**
- TuShare（ETF日线等）  
  - 注意：部分接口有积分门槛与频次限制，需要在上线前确认  
- 东方财富 Choice（EmQuantAPI/量化接口）  
  - 商业数据服务，适合做“稳定性与覆盖面”增强（基金、组合、回测等能力更体系化）

**资讯与解释层（可选，不作为交易事实）**
- Dow Jones / Wall Street Journal Top Stories / Content API（新闻流）  
  - 用途：事件解释、风险提示、宏观情景输入  
  - 约束：不得将新闻直接转化为强买卖指令；仅作为“解释性上下文”

### 4.4 数据健康检查与降级
- 每个数据拉取任务必须生成 `source_health`：
  - 响应码/解析成功率/字段完整度/更新时间/与上一日差异（异常波动检测）
- 降级策略：
  - 主源不可用 → 切换备源（或冻结到最近可用数据）  
  - 关键字段缺失（如净值）→ 只输出“缺失原因 + 最近可用日期”，禁止 AI 编造  
  - 异常波动触发（例如净值突变）→ 标记 `suspected_outlier`，告警降级为“人工确认提示”

---

## 5. 核心领域模型：模拟交易、持仓与结算

### 5.1 事件流（单一事实来源）
所有交易相关动作都写入 `simulation_trades`（事实表），持仓/盈亏从事实表重建或物化计算：
- BUY：按 `nav_price` 与 `shares` 记账  
- SELL：按 `nav_price` 与 `shares` 扣减  
- SIP（定投）：本质是周期性 BUY 事件  
- SETTLE：T+1 结算事件，改变 trade 状态（created → settled）

### 5.2 状态机与幂等
- `trade_status`: created / confirmed / settled / cancelled / failed  
- `idempotency_key`: 由 (user_id, fund_code, trade_type, trade_date, amount, nav_price, client_msg_id) 生成  
- 结算与持仓更新必须支持重复执行不出错（幂等更新/UPSERT）

---

## 6. 数据库设计（PostgreSQL）

### 6.1 关键表（建议结构）
- `users`：telegram_user_id、偏好、风险等级  
- `fund_master`：fund_code、name、type、currency、data_source_priority  
- `fund_nav_timeseries`：fund_code、date、nav、acc_nav、daily_pct、source、ingested_at、quality_flags  
- `simulation_trades`：trade_id、user_id、fund_code、trade_type、shares、amount、nav_price、trade_date、settle_date、trade_status、idempotency_key、raw_source  
- `positions_snapshot`（可选物化）：user_id、fund_code、as_of_date、shares、avg_cost、unrealized_pnl  
- `alert_rules`：rule_id、user_id、fund_code、rule_type、params_json、enabled、cooldown_seconds  
- `alert_events`：event_id、rule_id、triggered_at、payload_json、dedup_key、sent_at、status  
- `jobs`：job_id、job_type、scheduled_at、started_at、finished_at、status、attempt、idempotency_key、error  
- `ai_analyses`：analysis_id、user_id、fund_code、as_of_date、input_hash、providers_json、verdict_json、prompt_version、created_at

### 6.2 必须的索引/约束（最低集合）
- `simulation_trades(idempotency_key)` 唯一索引  
- `fund_nav_timeseries(fund_code, date)` 唯一索引  
- `alert_events(dedup_key)` 唯一索引  
- `jobs(idempotency_key)` 唯一索引  
- 所有时间序列表按 (code, date) 建索引；日志表按 (created_at) 建索引

---

## 7. 作业调度与并发策略

### 7.1 运行形态
- Bot 与 API Service：常驻服务  
- Scheduler：建议单实例（或用 Redis/Postgres advisory lock 保证“唯一执行”）  
- Worker：可水平扩展（多实例）

### 7.2 重试与补偿
- 所有外部调用（数据源、LLM）使用指数退避重试（带上限与抖动）。
- 失败超过阈值写入 `jobs.error` 并触发“系统告警”到管理员频道。

### 7.3 去重与冷却
- 预警 dedup_key 设计：`user_id + fund_code + rule_type + window_bucket`  
- window_bucket：按分钟/小时分桶，配合 cooldown_seconds 防刷屏

---

## 8. Telegram Bot（命令与交互）

### 8.1 基本命令（MVP）
- `/fund <code>`：基金信息与最新净值（含数据源与更新时间）
- `/nav <code> [n]`：最近 n 天净值曲线（文本/简图）
- `/buy_sim <code> <amount>`：模拟买入（生成交易事件）
- `/sell_sim <code> <shares|amount>`：模拟卖出
- `/sip add <code> <amount> <cycle>`：新增定投（daily/weekly/monthly）
- `/sip list|pause|resume|remove`：管理定投
- `/alert add ...`：新增预警（阈值/回撤/波动等）
- `/alert list|remove|mute`：管理预警
- `/report daily|weekly`：组合简报
- `/analyze <code>`：生成结构化分析（异步推送）

### 8.2 输出规范
- 所有输出带：数据源、更新时间、免责声明（模拟/非投资建议）。
- AI 输出必须包含：
  - `facts_used`（指标列表与日期）  
  - `unknowns`（缺失字段）  
  - `risk_notes`（风险点）  
  - `actions`（仅允许“查看/对比/关注”类建议，禁止强指令）

---

## 9. AI 分析：三模型裁决器（可追溯、可控）

### 9.1 统一 Provider 适配层
- 对 GLM / DeepSeek / MiniMax 抽象统一接口：`chat(messages, json_schema, timeout)`  
- 失败策略：单模型失败不影响裁决；两模型失败则降级为规则引擎报告

### 9.2 结构化输入（硬约束）
Worker 先计算并生成 `facts_json`（唯一允许模型使用的事实数据）：
- 收益（1W/1M/3M/1Y）、最大回撤、波动率（年化）、费用信息（若可得）
- 同类/指数对比（可选）
- 数据质量标记（outlier/缺失）

### 9.3 结构化输出（硬约束）
- 模型必须输出符合 JSON Schema 的 `analysis_json`  
- 解析失败 → 直接丢弃模型输出并降级

### 9.4 裁决机制（建议）
- 规则：两票一致优先；若分歧大，则输出“分歧点与原因”，而不是强行给结论  
- 置信度：来自一致性 + 数据质量 + 历史命中（后续迭代）

---

## 10. 可观测性与审计

- 日志：请求日志、任务日志、外部调用日志（脱敏）  
- 指标：任务成功率、数据更新时间延迟、预警触发/送达延迟、LLM耗时、缓存命中率  
- 追踪：至少在 Service 与 Worker 间传递 `trace_id`  
- 审计：所有交易事件、预警触发、AI 分析入库可回放

---

## 11. 安全与合规边界

- 明确“模拟交易/非投资建议”提示；禁止输出确定性承诺。
- Secrets：使用环境变量/密钥管理（不落库、不入日志）。
- 权限：按 Telegram `user_id` 隔离；管理员功能单独开关与令牌。
- 反滥用：限流（每用户每分钟命令数）；预警推送冷却；AI 分析配额。

---

## 12. 5日冲刺计划（修订版）

### Day 1：数据与事件骨架日（必须闭环）
- 数据：东方财富基金净值拉取 → 入库 → 查询命令返回（带 source/updated_at）
- 交易：/buy_sim 写入交易事实 → 结算任务（可手动触发）→ 持仓可重建
- 预警：最小规则（阈值）→ 去重 → 推送
- AI：单模型 + 结构化输入/输出（先跑通再扩展）

### Day 2：可靠性与作业体系
- Scheduler/Worker 分离；任务幂等与重试
- 缓存与去重键完善
- 基础监控（任务成功率/延迟）

### Day 3：分析与回测（最小可用）
- NAV 时序回测（定投/持有对比）
- 指标模块（收益/回撤/波动/夏普）
- AI 扩展到三模型裁决器（可追溯入库）

### Day 4：预警与组合功能增强
- 更多预警类型（回撤、波动、净值创新高/低）
- 日报/周报（组合维度）
- 管理命令与风控限制（风险等级/高风险模式）

### Day 5：上线与压测
- Docker 一键部署；Webhook 生产配置（或明确 polling 仅用于开发）
- 基础压测：并发命令、任务堆积、数据库索引验证
- 回滚预案与运行手册（Runbook）

---

## 13. 风险清单与回滚

### 13.1 主要风险
- 数据源不稳定/字段缺失 → 必须有降级与“缺失提示”，禁止 AI 编造
- 多实例重复调度 → Scheduler 唯一执行（锁）
- 预警刷屏 → dedup + cooldown + 用户 mute

### 13.2 回滚
- 新版本上线后问题：  
  - 先关闭 Scheduler（停止生成新任务）  
  - Bot 仅保留查询与只读能力  
  - 回滚容器镜像到上一版本  
- 数据修复：以 trade 事实表重建持仓；以 nav_timeseries 重建指标

---

## 14. 参考资料（链接放在代码块中便于复制）
```text
AkShare 公募基金数据文档（东方财富/天天基金网接口封装）:
- https://akshare.akfamily.xyz/data/fund/fund_public.html
- https://akshare-hh.readthedocs.io/en/latest/data/fund/fund_public.html

天天基金（开放式基金净值表，显示“交易日16:00～23:00更新”）:
- https://fund.eastmoney.com/fund.html

TuShare 权限说明与 ETF 日线（示例）:
- https://tushare.pro/document/1?doc_id=108
- https://tushare.pro/document/2?doc_id=127

东方财富 Choice 数据量化接口（Manual / Python PDF）:
- https://quantapi.eastmoney.com/Manual
- https://quantapi.eastmoney.com/Upload/EMQuantAPI_Python.pdf

Dow Jones Developer Platform / Top Stories API（WSJ 内容流）:
- https://developer.dowjones.com/
- https://developer.dowjones.com/documents/site-docs-newswires_apis-dow_jones_newswires_top_stories_api
- https://www.postman.com/dj-cse/dow-jones-apis/folder/u8fy7oz/top-stories-api
```
